<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UnionPay percent 뷰어</title>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#666; --card:#f6f7f8; --ok:#0a7; --err:#c33; --bd:#e5e7eb; }
  @media (prefers-color-scheme: dark) {
    :root { --bg:#0b0c0f; --fg:#e8e8ea; --muted:#9aa0a6; --card:#15171c; --ok:#42d392; --err:#ff6b6b; --bd:#2a2f36; }
  }
  html,body { margin:0; background:var(--bg); color:var(--fg); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; }
  .wrap { max-width:720px; margin:18px auto; padding:0 12px; }
  h1 { font-size:18px; margin:0 0 10px; }
  .meta { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:8px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 14px; }
  button { cursor:pointer; border:1px solid var(--bd); background:var(--card); color:var(--fg); padding:6px 10px; border-radius:8px; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { border:1px solid var(--bd); padding:10px; text-align:left; vertical-align:top; }
  .table th { background:var(--card); font-weight:600; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--bd); background:var(--card); }
  .ok { color:var(--ok); }
  .err { color:var(--err); }
  .muted { color:var(--muted); }
  .small { font-size:12px; }
</style>
<body>
<div class="wrap">
  <h1>카드별 잔여 예산</h1>
  <div class="meta">
    <span>마지막 갱신: <span id="lastUpdated" class="mono">-</span></span>
    <span>자동 새로고침: <span id="autoStatus" class="mono">OFF</span></span>
  </div>

  <div class="controls">
    <button id="refreshBtn">지금 새로고침</button>
  </div>

  <table class="table" id="resultTable" aria-label="카드 percent 테이블">
    <thead>
      <tr>
        <th style="width:120px">카드</th>
        <th style="width:140px">percent</th>
        <th>원시 값(JSON 경로)</th>
        <th style="width:150px">상태</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- JS가 채웁니다 -->
    </tbody>
  </table>
</div>

<script>
  // ===== 설정 =====
  const COMMON_BODY = {
    couponType: "07",
    merchantNo: "898618806634779",
    language: "kr",
    insCode: "299990156",
    type: "undefined"
  };

  const API_URL = "https://marketing.unionpayintl.com/h5Promote/v1/coupon/getCoupon";

  // 카드명 → couponno 매핑
  const CARDS = {
    "국민카드": "250919110660",
    "우리카드": "250904110568",
    "BC카드":   "250818110441",
    "IBK":     "250826110516"
  };

  // ===== 유틸 =====
  const $ = (sel) => document.querySelector(sel);

  function fmtPercent(v) {
    if (typeof v !== "number" || !isFinite(v)) return "—";
    return (v * 100).toFixed(2) + "%";
  }

  // JSON 객체에서 'percent' 키를 깊이 탐색하여 첫 번째 숫자 값을 찾음
  function findPercentPath(obj, path = []) {
    if (obj && typeof obj === "object") {
      for (const k of Object.keys(obj)) {
        const v = obj[k];
        const newPath = path.concat(k);
        if (k.toLowerCase() === "percent" && typeof v === "number" && isFinite(v)) {
          return { value: v, path: newPath };
        }
        if (v && typeof v === "object") {
          const found = findPercentPath(v, newPath);
          if (found) return found;
        }
      }
    }
    return null;
  }

  function pathToString(arr) {
    return arr.map(k => /^[a-zA-Z_]\w*$/.test(k) ? "."+k : `["${String(k).replace(/"/g, '\\"')}"]`).join("").replace(/^\./, "");
  }

  function nowStr() {
    // Asia/Seoul 기준 표시
    try {
      return new Date().toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
    } catch {
      return new Date().toLocaleString();
    }
  }

  // ===== 렌더링 =====
  function renderRow(card, data) {
    const tr = document.createElement("tr");

    const tdCard = document.createElement("td");
    tdCard.textContent = card;
    tr.appendChild(tdCard);

    const tdPercent = document.createElement("td");
    tdPercent.innerHTML = data?.ok
      ? `<span class="ok mono">${fmtPercent(data.percent)}</span>`
      : `<span class="err">—</span>`;
    tr.appendChild(tdPercent);

    const tdRaw = document.createElement("td");
    if (data?.ok) {
      const pathStr = data.path ? pathToString(data.path) : "";
      tdRaw.innerHTML = `
        <div class="mono small">${data.percent} <span class="muted">(raw)</span></div>
        <div class="muted small">${pathStr ? `경로: ${pathStr}` : ""}</div>
      `;
    } else {
      tdRaw.innerHTML = `<span class="muted small">${data?.msg || "에러"}</span>`;
    }
    tr.appendChild(tdRaw);

    const tdStatus = document.createElement("td");
    tdStatus.innerHTML = data?.ok
      ? `<span class="tag">OK</span>`
      : `<span class="tag err">ERROR</span>`;
    tr.appendChild(tdStatus);

    return tr;
  }

  function setLoadingState() {
    const tbody = $("#tbody");
    tbody.innerHTML = "";
    for (const card of Object.keys(CARDS)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${card}</td>
        <td class="muted">로딩 중…</td>
        <td class="muted small">요청 전송</td>
        <td><span class="tag">LOADING</span></td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ===== 네트워크 =====
  async function fetchPercentByCoupon(couponno) {
    const body = JSON.stringify({ couponno, ...COMMON_BODY });
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "accept": "application/json",
        "content-type": "application/json"
      },
      body,
      cache: "no-store",
    });
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${res.statusText}${text ? `: ${text.slice(0,180)}` : ""}`);
    }
    const json = await res.json();
    const found = findPercentPath(json);
    if (!found) {
      return { ok:false, msg:"percent 값을 찾지 못했습니다.", json };
    }
    return { ok:true, percent: found.value, path: found.path, json };
  }

  async function loadAll() {
    setLoadingState();
    const tbody = $("#tbody");
    tbody.innerHTML = "";

    const entries = Object.entries(CARDS);
    for (const [card, couponno] of entries) {
      try {
        const r = await fetchPercentByCoupon(couponno);
        tbody.appendChild(renderRow(card, r));
      } catch (e) {
        tbody.appendChild(renderRow(card, { ok:false, msg:String(e.message || e) }));
      }
    }
    $("#lastUpdated").textContent = nowStr();
  }

  // ===== 이벤트 =====
  $("#refreshBtn").addEventListener("click", loadAll);

  // 초기 로드
  loadAll().catch(console.error);
</script>
</body>
</html>
